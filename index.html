<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phần mềm Quản lý bán hàng - Cửa hàng VTNN Thành Nhân</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    tailwind.config = {
        darkMode: 'class'
    }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>

    <style type="text/tailwindcss">
        @layer components {
        /* all your .btn-base etc. */
    }
  </style>

    <link rel="manifest" href="/manifest.json">

    <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker
      .register('/service-worker.js')
      .then((registration) => {
        console.log('Service Worker registered with scope:', registration.scope);
      })
      .catch((error) => {
        console.log('Service Worker registration failed:', error);
      });
  }
    </script>


    <meta name="theme-color" content="#4f46e5"> <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer components {
            /* 1. Nút */
            .btn-base {
                @apply py-2.5 px-5 rounded-lg cursor-pointer text-sm font-medium transition-all duration-200 ease-in-out hover:-translate-y-0.5 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-900;
            }
            .btn-primary { 
                @apply btn-base bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500; 
            }
            .btn-secondary { 
                /* (SỬA) Nút phụ cho light/dark mode */
                @apply btn-base bg-indigo-50 text-indigo-700 hover:bg-indigo-100 focus:ring-indigo-500 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600;
            }
            .btn-success { 
                @apply btn-base bg-emerald-600 text-white hover:bg-emerald-700 focus:ring-emerald-500; 
            }
            .btn-danger { 
                @apply btn-base bg-red-600 text-white hover:bg-red-700 focus:ring-red-500; 
            }
            .btn-warning { 
                @apply btn-base bg-amber-500 text-white hover:bg-amber-600 focus:ring-amber-500; 
            }

            /* 2. Input */
            .input-base {
                @apply w-full p-3 border border-slate-300 rounded-lg box-border transition duration-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-800 dark:border-slate-600 dark:text-slate-200 dark:placeholder-slate-500 dark:focus:ring-indigo-500 dark:focus:border-indigo-500;
            }
            /* (MỚI) Trạng thái input khi "đã chọn" sản phẩm */
            .input-selected {
                @apply bg-indigo-50 border-indigo-300 dark:bg-indigo-900/50 dark:border-indigo-700;
            }

            /* 3. Class JS */
            .search-item {
                @apply p-3 cursor-pointer hover:bg-indigo-50 dark:hover:bg-slate-700;
            }
            .search-item small {
                @apply text-slate-500 ml-2 dark:text-slate-400;
            }
            .status-message {
                @apply p-4 mb-5 rounded-lg font-medium;
            }
            .status-success {
                @apply bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200;
            }
            .status-error {
                @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200;
            }

            /* 4. Bảng */
            .table-base {
                @apply w-full border-collapse text-sm text-left min-w-[768px];
            }
            .table-base th, .table-base td {
                @apply border border-slate-200 p-3 text-left dark:border-slate-700;
            }
            .table-base th {
                @apply bg-slate-50 font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-300;
            }

            /* 5. Trạng thái phiên */
            .status-session-active {
                @apply bg-emerald-600 text-white transition-all duration-300;
            }
            .status-session-inactive {
                @apply bg-amber-500 text-white transition-all duration-300;
            }

            /* 6. Fieldset */
            fieldset:disabled {
                @apply opacity-60 pointer-events-none;
            }
            fieldset:disabled .card-base {
                @apply bg-slate-50 dark:bg-slate-800/50; /* Làm mờ nền của các card */
            }
            
            /* 7. Card */
            .card-base {
                @apply bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-200 p-6 border border-gray-200 dark:bg-slate-800 dark:border-slate-700;
            }
            .card-title {
                @apply text-2xl font-semibold text-gray-900 flex items-center gap-2 mb-4 dark:text-white;
            }
            .card-title-bar {
                @apply inline-block w-1.5 h-6 bg-indigo-500 rounded;
            }
            .card-desc {
                @apply mb-5 text-gray-600 leading-relaxed dark:text-slate-400;
            }
            .card-desc strong {
                @apply font-medium text-gray-800 dark:text-slate-200;
            }
            
            /* 8. Modal */
            .modal-overlay {
                @apply fixed inset-0 bg-black/60 dark:bg-black/70 z-[99] flex items-center justify-center p-4 transition-opacity duration-200;
            }
            .modal-content {
                @apply bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-lg transform scale-100 transition-transform duration-200 dark:border dark:border-slate-700;
            }
            .modal-overlay.hidden {
                @apply opacity-0 pointer-events-none;
            }
            .modal-overlay.hidden .modal-content {
                @apply scale-95;
            }
            
            /* (MỚI) Tối ưu bảng cho Di động
              Biến bảng thành dạng "card" trên màn hình nhỏ
            */
            @media (max-width: 767px) {
                .mobile-table-optimise {
                    @apply border-0;
                }
                /* Ẩn <thead> trên mobile */
                .mobile-table-optimise thead {
                    @apply hidden;
                }
                /* Biến <tr> thành card */
                .mobile-table-optimise tr {
                    @apply block mb-4 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden;
                }
                .mobile-table-optimise td {
                    @apply block text-right p-3 border-b border-slate-100 dark:border-slate-700;
                    /* Căn chỉnh text-right để giá trị luôn ở bên phải */
                }
                /* Dòng cuối cùng không cần border-b */
                .mobile-table-optimise td:last-child {
                    @apply border-b-0;
                }
                
                /* Thêm label vào trước cell */
                .mobile-table-optimise td::before {
                    content: attr(data-label); /* Lấy nội dung từ data-label */
                    @apply float-left font-medium text-slate-700 dark:text-slate-300 mr-4;
                }
                
                /* Tùy chỉnh riêng cho nút Xóa */
                .mobile-table-optimise td.cell-action {
                    @apply text-center p-0; /* Nút xóa chiếm toàn bộ */
                }
                .mobile-table-optimise td.cell-action button {
                    @apply w-full rounded-none rounded-b-lg m-0;
                }
                .mobile-table-optimise td.cell-action::before {
                    @apply hidden; /* Không cần label cho nút Xóa */
                }
            }
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 font-sans text-slate-900 dark:text-slate-200 leading-relaxed transition-colors duration-200">

<header class="bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 px-4 sm:px-6 py-4 flex items-center justify-between sticky top-0 z-50 shadow-sm">
  <div class="flex items-center gap-3">
    <div class="bg-indigo-600 text-white p-2 rounded-xl shadow-sm">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </div>
    <div>
      <h1 class="text-lg md:text-2xl font-semibold text-gray-900 dark:text-white tracking-tight">
        Phần mềm Quản lý bán hàng
      </h1>
      <p class="text-sm text-gray-500 dark:text-slate-400 hidden sm:block">Cửa hàng VTNN Thành Nhân</p>
    </div>
  </div>

  <div class="flex items-center gap-3 md:gap-6">
    <div id="session-time-container" class="hidden md:flex flex-col text-right">
      <div class="text-lg font-semibold text-gray-800 dark:text-slate-200" id="current-time-display">--:--:--</div>
      <div class="text-sm text-gray-500 dark:text-slate-400" id="current-date-display">--/--/----</div>
    </div>
    
    <button id="theme-toggle-btn" class="p-2 rounded-lg text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Toggle dark mode">
      <svg id="theme-icon-sun" class="h-6 w-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
      <svg id="theme-icon-moon" class="h-6 w-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>
    </button>
  </div>
</header>


<div id="session-status-bar" class="text-center p-3 font-medium status-session-inactive sticky top-[73px] z-40" role="status">
    Đang tải...
</div>

<div class="max-w-7xl mx-auto p-4 md:p-6 pt-8">
    <div id="status-container" class="sticky top-[125px] z-30"></div>
    
    <div class="card-base md:col-span-2 mb-6">
        <h2 class="card-title">
            <span class="card-title-bar"></span>
            Phiên Làm Việc
        </h2>

        <p class="card-desc">
            Bắt đầu bằng cách tải <strong>Cơ sở dữ liệu</strong>.  
            Kết thúc phiên sẽ <span class="text-indigo-600 dark:text-indigo-400 font-medium">xuất tất cả báo cáo</span> và <span class="text-red-500 font-medium">xóa dữ liệu</span>.
        </p>

        <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-5">
            <input 
                type="file" 
                id="file-input" 
                accept=".xlsx, .xls, .csv" 
                class="hidden" 
            >
            <label for="file-input" class="btn-secondary !py-2.5 !px-5 shrink-0 cursor-pointer text-center">
                Chọn tệp CSDL...
            </label>
            <span id="file-name-display" class="text-sm text-slate-500 dark:text-slate-400 italic truncate">
                Chưa chọn tệp nào.
            </span>
        </div>

        <div class="flex flex-wrap gap-3">
            <button id="load-db-btn" class="btn-primary flex-grow sm:flex-grow-0">
                Bắt đầu phiên (Tải CSDL)
            </button>
            <button id="view-database-btn" disabled class="btn-secondary flex-grow sm:flex-grow-0">
                Xem CSDL
            </button>
            <button id="export-inventory-btn" disabled class="btn-secondary flex-grow sm:flex-grow-0">
                Xuất Tồn Kho
            </button>
            <button id="export-sales-report-btn" disabled class="btn-secondary flex-grow sm:flex-grow-0">
                Xuất BC Bán Hàng
            </button>
            <button id="view-exports-btn" disabled class="btn-secondary flex-grow sm:flex-grow-0">
                Xem HĐ đã xuất
            </button>
            <button id="end-session-btn" disabled class="btn-danger flex-grow sm:flex-grow-0">
                Kết thúc phiên
            </button>
        </div>
    </div>


    <fieldset id="main-app-controls" disabled>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="card-base">
                <h2 class="card-title">
                    <span class="card-title-bar"></span>
                    1. Tạo Đơn Hàng
                </h2>

                <form id="add-product-form" class="space-y-4">
                    <div>
                        <label for="product-search" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">Tìm kiếm sản phẩm:</label>
                        <input type="text" id="product-search" placeholder="Nhập tên sản phẩm..." class="input-base" />
                    </div>

                    <div id="bypass-inputs" class="hidden space-y-4 pt-2">
                        <p class="text-sm font-medium text-indigo-600 dark:text-indigo-400">
                          Chế độ Bypass: Nhập thông tin sản phẩm thủ công
                        </p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="product-unit" class="font-medium text-gray-700 dark:text-slate-300 block mb-1 text-sm">ĐVT:</label>
                                <input type="text" id="product-unit" placeholder="Cái, Chai, Bao..." class="input-base !py-2.5 !text-sm" />
                            </div>
                            <div>
                                <label for="product-price" class="font-medium text-gray-700 dark:text-slate-300 block mb-1 text-sm">Đơn giá:</label>
                                <input type="number" id="product-price" placeholder="0" min="0" class="input-base !py-2.5 !text-sm" />
                            </div>
                        </div>
                        <div class="h-px bg-slate-200 dark:bg-slate-700"></div> </div>
                    <div id="product-search-results"
                        class="max-h-52 overflow-y-auto border border-gray-300 rounded-lg bg-white dark:bg-slate-800 dark:border-slate-600 shadow-inner mb-2">
                    </div>

                    <div>
                        <label for="product-quantity" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">Số lượng:</label>
                        <input type="number" id="product-quantity" placeholder="Nhập số lượng" min="0" class="input-base" />
                    </div>

                    <button type="submit" class="btn-success w-full !py-3">
                        Thêm vào giỏ hàng
                    </button>
                </form>
            </div>

            <div class="card-base">
                <h2 class="card-title">
                    <span class="card-title-bar"></span>
                    2. Thông Tin Khách Hàng
                </h2>

                <form id="customer-info-form" class="grid grid-cols-1 sm:grid-cols-2 gap-x-5 gap-y-4">
                    <div>
                        <label for="customer-name" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">Tên khách hàng:</label>
                        <input type="text" id="customer-name" required class="input-base" />
                    </div>
                    <div>
                        <label for="customer-buyer-name" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">Người mua hàng:</label>
                        <input type="text" id="customer-buyer-name" class="input-base" />
                    </div>
                    <div>
                        <label for="customer-address" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">Địa chỉ:</label>
                        <input type="text" id="customer-address" class="input-base" />
                    </div>
                    <div>
                        <label for="customer-tin" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">Mã số thuế:</label>
                        <input type="text" id="customer-tin" class="input-base" />
                    </div>
                    <div>
                        <label for="customer-email" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">Email:</label>
                        <input type="email" id="customer-email" class="input-base" />
                    </div>
                    <div>
                        <label for="customer-payment-method" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">Hình thức thanh toán:</label>
                        <input type="text" id="customer-payment-method" value="Tiền mặt" class="input-base" />
                    </div>
                    <div>
                        <label for="customer-mdvcqhns" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">MDVCQHVNS:</label>
                        <input type="text" id="customer-mdvcqhns" class="input-base" />
                    </div>
                    <div>
                        <label for="customer-cccd" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">Số CCCD:</label>
                        <input type="text" id="customer-cccd" class="input-base" />
                    </div>
                    <div>
                        <label for="customer-passport" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">Số hộ chiếu:</label>
                        <input type="text" id="customer-passport" class="input-base" />
                    </div>
                    <div>
                        <label for="invoice-date" class="font-medium text-gray-700 dark:text-slate-300 block mb-1">Ngày hóa đơn:</label>
                        <input type="date" id="invoice-date" class="input-base [color-scheme:light] dark:[color-scheme:dark]" />
                    </div>
                </form>
            </div>
        </div>

        <div class="card-base md:col-span-2 mt-6">
            <h2 class="card-title">
                <span class="card-title-bar"></span>
                3. Giỏ Hàng Hiện Tại
            </h2>

            <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-slate-700">
                <table id="cart-table" class="table-base mobile-table-optimise">
                    <thead class="bg-gray-50 dark:bg-slate-800 text-gray-700 dark:text-slate-300 uppercase text-xs tracking-wider">
                        <tr>
                            <th class="px-4 py-3">STT</th>
                            <th class="px-4 py-3">Tên hàng hóa/dịch vụ</th>
                            <th class="px-4 py-3">ĐVT</th>
                            <th class="px-4 py-3">Số lượng</th>
                            <th class="px-4 py-3">Đơn giá</th>
                            <th class="px-4 py-3">Thành tiền</th>
                            <th class="px-4 py-3 text-center">Xóa</th>
                        </tr>
                    </thead>
                    <tbody id="cart-body" class="divide-y divide-gray-200 dark:divide-slate-700">
                        </tbody>
                </table>
            </div>

            <div id="cart-total-container" class="text-right mt-6 space-y-2">
                <div id="cart-total-posttax" class="text-3xl font-bold text-red-600 dark:text-red-500">
                    Tổng cộng: 0 VNĐ
                </div>
            </div>

            <div class="mt-6 border-t border-gray-200 dark:border-slate-700 pt-6 flex flex-wrap gap-x-4 gap-y-3 justify-end items-center">
                <label class="flex items-center text-sm text-gray-600 dark:text-slate-400 mr-auto sm:mr-0 cursor-pointer order-last sm:order-first">
                    <input type="checkbox" id="save-invoice-only-check" class="h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:checked:bg-indigo-600">
                    <span class="ml-2">Chỉ lưu, không tải file</span>
                </label>
                <button id="export-invoice-btn" class="btn-primary flex-grow sm:flex-grow-0">
                    Xuất Hóa Đơn Này
                </button>
                <button id="clear-cart-btn" class="btn-secondary flex-grow sm:flex-grow-0">
                    Tạo Đơn Hàng Mới
                </button>
            </div>
        </div>
    </fieldset>
</div> 
<div id="info-modal" class="modal-overlay hidden" aria-labelledby="info-modal-title" role="dialog" aria-modal="true">
    <div id="modal-overlay-bg-info" class="fixed inset-0"></div>
    <div class="modal-content relative">
        <div class="flex justify-between items-center mb-4">
            <h3 id="info-modal-title" class="text-xl font-semibold text-gray-900 dark:text-white">
                Thông tin phần mềm
            </h3>
            <button id="modal-close-btn-info" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="space-y-3 text-gray-600 dark:text-slate-300">
            <p><strong>Tên phần mềm:</strong> Phần mềm Quản lý bán hàng - Cửa hàng VTNN Thành Nhân</p>
            <p><strong>Phát triển bởi:</strong> Cửa hàng VTNN Thành Nhân</p>
            <p><strong>Phiên bản:</strong> <span class="font-semibold text-indigo-600 dark:text-indigo-400">1.5</span></p>
            <p class="mt-4 pt-4 border-t dark:border-slate-700 text-sm">Phần mềm này giúp quản lý việc xuất hóa đơn bán hàng và theo dõi tồn kho trong ngày.</p>
        </div>
    </div>
</div>

<div id="end-session-modal" class="modal-overlay hidden" aria-labelledby="end-session-modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0"></div>
    <div class="modal-content relative">
        <h3 id="end-session-modal-title" class="text-xl font-semibold text-gray-900 dark:text-white mb-3">
            Kết thúc phiên làm việc
        </h3>
        <p class="text-gray-600 dark:text-slate-300 mb-6">
            Chọn các báo cáo bạn muốn xuất trước khi kết thúc phiên.
        </p>
        <div class="space-y-4 mb-6">
            <label class="flex items-center p-3 rounded-lg border dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer">
                <input type="checkbox" id="end-session-check-sales" class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-slate-600 dark:bg-slate-900 dark:checked:bg-indigo-600" checked>
                <span class="ml-3 font-medium text-gray-800 dark:text-slate-200">Xuất Báo Cáo Bán Hàng</span>
            </label>
            <label class="flex items-center p-3 rounded-lg border dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer">
                <input type="checkbox" id="end-session-check-inventory" class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-slate-600 dark:bg-slate-900 dark:checked:bg-indigo-600" checked>
                <span class="ml-3 font-medium text-gray-800 dark:text-slate-200">Xuất Báo Cáo Tồn Kho</span>
            </label>
        </div>
        <div class="flex flex-wrap gap-3 justify-end">
            <button id="end-session-modal-cancel-btn" class="btn-secondary">
                Hủy bỏ
            </button>
            <button id="end-session-modal-continue-btn" class="btn-primary">
                Tiếp tục
            </button>
        </div>
    </div>
</div>

<div id="advanced-modal" class="modal-overlay hidden" aria-labelledby="advanced-modal-title" role="dialog" aria-modal="true">
    <div id="modal-overlay-bg-adv" class="fixed inset-0"></div>
    <div class="modal-content relative">
        <div class="flex justify-between items-center mb-4">
            <h3 id="advanced-modal-title" class="text-xl font-semibold text-gray-900 dark:text-white">
                Chế độ Nâng cao (Developer)
            </h3>
            <button id="modal-close-btn-adv" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div class="space-y-5">
            <div>
                <h4 class="font-medium text-gray-800 dark:text-slate-300 mb-2">Kiểm thử Hóa đơn</h4>
                <button id="dev-bypass-btn" class="btn-warning w-full text-left !py-2 !px-4">
                    Bypass Nhập CSDL: <span class="font-bold">[TẮT]</span>
                </button>
                <p class="text-sm text-gray-500 dark:text-slate-400 mt-1 px-1">
                    Cho phép nhập sản phẩm thủ công (tên, giá) vào giỏ hàng.
                </p>
            </div>
            
            <div>
                <h4 class="font-medium text-gray-800 dark:text-slate-300 mb-2">Xuất Template (Trống)</h4>
                <div class="flex flex-wrap gap-2">
                    <button id="export-empty-invoice-btn" class="btn-secondary !py-2 !px-4 flex-1">Hóa Đơn</button>
                    <button id="export-empty-sales-btn" class="btn-secondary !py-2 !px-4 flex-1">Báo Cáo Bán Hàng</button>
                    <button id="export-empty-inventory-btn" class="btn-secondary !py-2 !px-4 flex-1">Báo Cáo Tồn Kho</button>
                </div>
                <p class="text-sm text-gray-500 dark:text-slate-400 mt-1 px-1">
                    Xuất các file mẫu (chỉ có tiêu đề) để kiểm tra định dạng.
                </p>
            </div>
            
            <div>
                <h4 class="font-medium text-gray-800 dark:text-slate-300 mb-2">Quản lý Phiên (Backup/Restore)</h4>
                <p class="text-sm text-gray-500 dark:text-slate-400 mb-2 px-1">
                    Dùng để chuyển/khôi phục dữ liệu phiên (CSDL, Giao dịch, Log Hóa đơn) giữa các thiết bị.
                </p>
                <div class="flex flex-wrap gap-2">
                    <button id="backup-session-btn" class="btn-primary !py-2 !px-4 flex-1">
                        Xuất file Backup (.json)
                    </button>
                    
                    <input type="file" id="restore-file-input" class="hidden" accept=".json">
                    <label for="restore-file-input" class="btn-danger !py-2 !px-4 flex-1 cursor-pointer text-center">
                        Nhập file Restore (.json)
                    </label>
                </div>
                <p class="text-sm text-gray-500 dark:text-slate-400 mt-1 px-1">
                    <span class="font-bold text-red-600 dark:text-red-400">CẢNH BÁO:</span> Thao tác 'Nhập' sẽ <span class="font-bold">xóa sạch</span> phiên hiện tại.
                </p>
            </div>

        </div>
    </div>
</div>

<div id="confirm-modal" class="modal-overlay hidden" aria-labelledby="confirm-modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0"></div>
    <div class="modal-content relative">
        <h3 id="confirm-modal-title" class="text-xl font-semibold text-gray-900 dark:text-white mb-3">
            Xác nhận
        </h3>
        <p id="confirm-modal-message" class="text-gray-600 dark:text-slate-300 mb-6">
            Bạn có chắc chắn muốn thực hiện hành động này?
        </p>
        <div class="flex flex-wrap gap-3 justify-end">
            <button id="confirm-modal-cancel-btn" class="btn-secondary">
                Hủy bỏ
            </button>
            <button id="confirm-modal-confirm-btn" class="btn-danger">
                Xác nhận
            </button>
        </div>
    </div>
</div>

<div id="exported-invoices-modal" class="modal-overlay hidden" aria-labelledby="exported-invoices-modal-title" role="dialog" aria-modal="true">
    <div id="modal-overlay-bg-exports" class="fixed inset-0"></div>
    <div class="modal-content relative !max-w-4xl"> <div class="flex justify-between items-center mb-4">
            <h3 id="exported-invoices-modal-title" class="text-xl font-semibold text-gray-900 dark:text-white">
                Hóa đơn đã xuất (Phiên này)
            </h3>
            <button id="modal-close-btn-exports" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <p class="text-sm text-gray-500 dark:text-slate-400 mb-4">
            Đây là danh sách các hóa đơn đã được tạo và xuất file trong phiên làm việc này. Bạn có thể tải lại nếu lỡ hủy hộp thoại tải về.
        </p>

        <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-slate-700 max-h-[60vh] overflow-y-auto">
            <table class="table-base !min-w-full mobile-table-optimise">
                <thead>
                    <tr>
                        <th>Tên khách hàng</th>
                        <th>Thời gian xuất</th>
                        <th>Tên file</th>
                        <th>Loại</th> <th class="text-center">Tải lại</th>
                    </tr>
                </thead>
                <tbody id="exported-invoices-list" class="divide-y divide-gray-200 dark:divide-slate-700">
                    </tbody>
            </table>
        </div>

    </div>
</div>

<div id="database-viewer-modal" class="modal-overlay hidden" aria-labelledby="database-viewer-modal-title" role="dialog" aria-modal="true">
    <div id="modal-overlay-bg-db" class="fixed inset-0"></div>
    <div class="modal-content relative !max-w-6xl"> <div class="flex justify-between items-center mb-4">
            <h3 id="database-viewer-modal-title" class="text-xl font-semibold text-gray-900 dark:text-white">
                Cơ sở dữ liệu Sản phẩm
            </h3>
            <button id="modal-close-btn-db" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div class="mb-4">
            <input type="text" id="db-modal-search-input" placeholder="Tìm kiếm theo tên sản phẩm..." class="input-base">
        </div>

        <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-slate-700 max-h-[60vh] overflow-y-auto">
            <table class="table-base !min-w-full">
                <thead>
                    <tr>
                        <th class="!p-2 !text-center">STT</th>
                        <th class="!p-2">Tên sản phẩm</th>
                        <th class="!p-2">ĐVT</th>
                        <th class="!p-2 !text-right">Đơn giá</th>
                        <th class="!p-2 !text-right">Tồn kho</th>
                    </tr>
                </thead>
                <tbody id="database-viewer-list" class="divide-y divide-gray-200 dark:divide-slate-700">
                    </tbody>
            </table>
        </div>

    </div>
</div>

    
<footer class="bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 py-6 px-4 text-center text-sm text-gray-500 dark:text-slate-400">
  <p>
    © 2025 <span class="font-medium text-gray-700 dark:text-slate-300">Cửa hàng VTNN Thành Nhân</span> — Phiên bản <span class="font-semibold">1.5</span>
  </p>
  <p class="mt-2">
    <button id="advanced-mode-btn" class="text-xs text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 transition-colors">
      Chế độ nâng cao
    </button>
    <button id="info-mode-btn" class="text-xs text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 transition-colors ml-4">
      Thông tin phần mềm
    </button>
  </p>
</footer>


<script>
// --- BIẾN TOÀN CỤC ---
let productDatabase = []; 
let productDatabaseOriginal = [];
let currentCart = []; 
let dailyTransactions = []; 
let exportedInvoicesLog = []; // (MỚI) Log hóa đơn đã xuất
let selectedProduct = null; 
let devBypassMode = false;

// (MỚI) Biến cho Modal Xác nhận
let confirmModal = null;
let confirmModalConfirmBtn = null;
let confirmModalCancelBtn = null;
let confirmModalTitle = null;
let confirmModalMessage = null;
let onConfirmCallback = () => {}; // Callback để gọi khi nhấn OK

// (MỚI) Biến cho Dark Mode
let themeToggleBtn = null;
let themeIconSun = null;
let themeIconMoon = null;

// (MỚI) Biến cho Modal Hóa đơn đã xuất
let exportedInvoicesModal = null;
let exportedInvoicesList = null;

// (*** MỚI ***) Biến cho Modal Kết thúc Phiên
let endSessionModal = null;
let endSessionCheckSales = null;
let endSessionCheckInventory = null;
let endSessionModalContinueBtn = null;
let endSessionModalCancelBtn = null;

// (*** MỚI ***) Biến cho Modal Thông tin
let infoModal = null;

// (*** MỚI ***) Biến cho Modal Xem CSDL
let databaseViewerModal = null;
let databaseViewerList = null;
let dbModalSearchInput = null;


// --- 1. KHỞI TẠO & SỰ KIỆN ---
document.addEventListener('DOMContentLoaded', () => {
    // Gán biến Modal
    confirmModal = document.getElementById('confirm-modal');
    confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
    confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
    confirmModalTitle = document.getElementById('confirm-modal-title');
    confirmModalMessage = document.getElementById('confirm-modal-message');

    // (*** MỚI ***) Gán biến Modal Kết thúc Phiên
    endSessionModal = document.getElementById('end-session-modal');
    endSessionCheckSales = document.getElementById('end-session-check-sales');
    endSessionCheckInventory = document.getElementById('end-session-check-inventory');
    endSessionModalContinueBtn = document.getElementById('end-session-modal-continue-btn');
    endSessionModalCancelBtn = document.getElementById('end-session-modal-cancel-btn');

    // (*** MỚI ***) Gán biến Modal Thông tin
    infoModal = document.getElementById('info-modal');
    
    // (*** MỚI ***) Gán biến Modal Xem CSDL
    databaseViewerModal = document.getElementById('database-viewer-modal');
    databaseViewerList = document.getElementById('database-viewer-list');
    dbModalSearchInput = document.getElementById('db-modal-search-input');

    // Gán biến Dark Mode
    themeToggleBtn = document.getElementById('theme-toggle-btn');
    themeIconSun = document.getElementById('theme-icon-sun');
    themeIconMoon = document.getElementById('theme-icon-moon');

    // Khởi tạo
    document.getElementById('invoice-date').valueAsDate = new Date();
    loadStateFromStorage(); // Hàm này sẽ tự động gọi updateSessionStatus & updateExportedInvoicesButtonState
    setupThemeToggle(); // (MỚI)
    setupExportedInvoicesModal(); // (MỚI)
    setupInfoModal(); // (*** MỚI ***)
    setupEndSessionModal(); // (*** MỚI ***)
    setupDatabaseViewerModal(); // (*** MỚI ***)
    startClock(); // (MỚI)

    // Gán sự kiện cho các nút
    document.getElementById('load-db-btn').addEventListener('click', handleFileLoad);
    document.getElementById('export-inventory-btn').addEventListener('click', exportInventory);
    document.getElementById('export-sales-report-btn').addEventListener('click', exportDailySalesReport); // (*** MỚI ***)
    document.getElementById('end-session-btn').addEventListener('click', startEndSessionProcess); // (*** SỬA ***)
    document.getElementById('add-product-form').addEventListener('submit', handleAddProduct);
    document.getElementById('product-search').addEventListener('keyup', handleProductSearch);
    document.getElementById('export-invoice-btn').addEventListener('click', exportInvoiceFile);
    document.getElementById('clear-cart-btn').addEventListener('click', () => clearCart(true)); // (SỬA) Bọc trong hàm
    
    // (MỚI) Gán sự kiện cho File Input
    document.getElementById('file-input').addEventListener('change', updateFileNameDisplay);

    // (MỚI) Gán sự kiện cho Modal Nâng cao
    document.getElementById('advanced-mode-btn').addEventListener('click', showAdvancedModal);
    document.getElementById('modal-close-btn-adv').addEventListener('click', hideAdvancedModal);
    document.getElementById('modal-overlay-bg-adv').addEventListener('click', hideAdvancedModal);
    
    document.getElementById('dev-bypass-btn').addEventListener('click', toggleBypassMode);
    document.getElementById('export-empty-invoice-btn').addEventListener('click', exportEmptyInvoice);
    document.getElementById('export-empty-sales-btn').addEventListener('click', exportEmptySalesReport);
    document.getElementById('export-empty-inventory-btn').addEventListener('click', exportEmptyInventory);
    
    // (*** MỚI ***) Gán sự kiện cho Backup/Restore
    document.getElementById('backup-session-btn').addEventListener('click', handleBackupSession);
    document.getElementById('restore-file-input').addEventListener('change', handleRestoreSession);

    // (MỚI) Gán sự kiện cho Modal Xác nhận
    confirmModalConfirmBtn.addEventListener('click', () => {
        onConfirmCallback();
        hideConfirmModal();
    });
    confirmModalCancelBtn.addEventListener('click', hideConfirmModal);
    
    // (*** MỚI ***) Gán sự kiện cho Modal Thông tin (Đã chuyển vào setupInfoModal)
    // document.getElementById('info-mode-btn').addEventListener('click', showInfoModal);
});

// --- (MỚI) HÀM TIỆN ÍCH MODAL XÁC NHẬN ---
/**
 * Hiển thị modal xác nhận (thay thế window.confirm)
 * @param {string} title Tiêu đề của modal
 * @param {string} message Nội dung thông báo
 * @param {function} onConfirm Hàm callback sẽ chạy khi nhấn "Xác nhận"
 * @param {string} confirmBtnClass (Tùy chọn) Class của nút xác nhận (vd: 'btn-danger', 'btn-success')
 */
function showConfirmModal(title, message, onConfirm, confirmBtnClass = 'btn-danger') {
    confirmModalTitle.textContent = title;
    confirmModalMessage.textContent = message;
    onConfirmCallback = onConfirm;
    
    // Reset class nút
    confirmModalConfirmBtn.className = ''; // Xóa hết class cũ
    confirmModalConfirmBtn.classList.add('btn-base', confirmBtnClass); // Thêm class mới
    
    confirmModal.classList.remove('hidden');
}

function hideConfirmModal() {
    confirmModal.classList.add('hidden');
    onConfirmCallback = () => {}; // Xóa callback
}

// --- (MỚI) HÀM TIỆN ÍCH DARK MODE ---
function setupThemeToggle() {
    // Cập nhật icon dựa trên trạng thái hiện tại
    function updateIcon() {
        if (document.documentElement.classList.contains('dark')) {
            themeIconMoon.classList.add('hidden');
            themeIconSun.classList.remove('hidden');
        } else {
            themeIconSun.classList.add('hidden');
            themeIconMoon.classList.remove('hidden');
        }
    }
    
    updateIcon(); // Chạy lần đầu
    
    // Gán sự kiện click
    themeToggleBtn.addEventListener('click', () => {
        if (document.documentElement.classList.contains('dark')) {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        } else {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        }
        updateIcon(); // Cập nhật lại icon
    });
}

// --- (MỚI) HÀM TIỆN ÍCH FILE INPUT ---
function updateFileNameDisplay() {
    const fileInput = document.getElementById('file-input');
    const display = document.getElementById('file-name-display');
    if (fileInput.files.length > 0) {
        display.textContent = fileInput.files[0].name;
        display.classList.remove('italic');
    } else {
        display.textContent = 'Chưa chọn tệp nào.';
        display.classList.add('italic');
    }
}

// --- CÁC HÀM TIỆN ÍCH (Hiển thị thông báo) ---
function showStatus(message, isError = false) {
    const container = document.getElementById('status-container');
    const statusDiv = document.createElement('div');
    statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
    statusDiv.textContent = message;
    container.innerHTML = ''; 
    container.appendChild(statusDiv);
    window.scrollTo(0, 0);
    setTimeout(() => { if (container.contains(statusDiv)) container.removeChild(statusDiv); }, 6000);
}

const currencyFormatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

/**
 * (MỚI) Formats a date object or a yyyy-mm-dd string into dd/mm/yyyy.
 * @param {Date | string} dateInput The date object or string to format.
 */
function formatDateDDMMYYYY(dateInput) {
    if (!dateInput) return '';
    
    let dateObj;
    if (typeof dateInput === 'string' && dateInput.includes('-')) {
        // Handle 'yyyy-mm-dd' string from <input type="date">
        const parts = dateInput.split('-');
        if (parts.length === 3) {
            // new Date(year, monthIndex, day) - month is 0-indexed
            dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
        } else {
            dateObj = new Date(dateInput); // Fallback
        }
    } else {
        dateObj = new Date(dateInput);
    }
    
    // Check for invalid date
    if (isNaN(dateObj.getTime())) {
        return ''; // Return empty string for invalid dates
    }

    const day = String(dateObj.getDate()).padStart(2, '0');
    const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
    const year = dateObj.getFullYear();
    return `${day}/${month}/${year}`;
}

// --- QUẢN LÝ TRẠNG THÁI PHIÊN & GIAO DIỆN ---
function updateSessionStatus() {
    const statusBar = document.getElementById('session-status-bar');
    const isSessionActive = productDatabase.length > 0;

    if (isSessionActive) {
        statusBar.textContent = `Phiên làm việc đang diễn ra. CSDL: ${productDatabase.length} SP. Giao dịch: ${dailyTransactions.length}.`;
        statusBar.className = 'text-center p-3 font-medium status-session-active sticky top-[73px] z-40';
    } else {
        statusBar.textContent = 'Chưa có phiên làm việc. Vui lòng tải Cơ sở dữ liệu để bắt đầu.';
        statusBar.className = 'text-center p-3 font-medium status-session-inactive sticky top-[73px] z-40';
    }
    
    toggleAppControls(isSessionActive, devBypassMode);
    updateExportedInvoicesButtonState(); // (MỚI) Cập nhật nút HĐ đã xuất
}

function toggleAppControls(isSessionActive, isBypassActive = false) {
    document.getElementById('export-inventory-btn').disabled = !isSessionActive;
    document.getElementById('export-sales-report-btn').disabled = !isSessionActive; // (*** MỚI ***)
    document.getElementById('end-session-btn').disabled = !isSessionActive;
    document.getElementById('view-database-btn').disabled = !isSessionActive; // (*** MỚI ***)
    document.getElementById('main-app-controls').disabled = !isSessionActive && !isBypassActive;
    
    const loadDbBtn = document.getElementById('load-db-btn');
    if (isSessionActive) {
        loadDbBtn.textContent = 'Tải lại CSDL (Phiên mới)';
        loadDbBtn.classList.remove('btn-primary');
        loadDbBtn.classList.add('btn-danger');
    } else {
        loadDbBtn.textContent = 'Bắt đầu phiên (Tải CSDL)';
        loadDbBtn.classList.remove('btn-danger');
        loadDbBtn.classList.add('btn-primary');
    }
}

// (MỚI) Cập nhật trạng thái nút "Xem HĐ đã xuất"
function updateExportedInvoicesButtonState() {
    const btn = document.getElementById('view-exports-btn');
    if (!btn) return; // Guard clause
    const isSessionActive = productDatabase.length > 0;
    // Chỉ bật khi phiên hoạt động VÀ có log hóa đơn
    btn.disabled = !(isSessionActive && exportedInvoicesLog.length > 0);
}


// --- 2. QUẢN LÝ DỮ LIỆU & STATE (LOCALSTORAGE) ---
function saveStateToStorage() {
    const state = {
        current: productDatabase,
        original: productDatabaseOriginal,
        transactions: dailyTransactions 
    };
    localStorage.setItem('inventoryState', JSON.stringify(state));
    // (MỚI) Log hóa đơn được lưu riêng (trong hàm exportInvoiceFile)
    // vì nó không thuộc về "state" của tồn kho
}

function loadStateFromStorage() {
    // 1. Tải state tồn kho
    const savedState = localStorage.getItem('inventoryState');
    if (savedState) {
        try {
            const state = JSON.parse(savedState);
            if (state.current && state.original) {
                productDatabase = state.current;
                productDatabaseOriginal = state.original;
                dailyTransactions = state.transactions || []; 
                showStatus('Đã khôi phục dữ liệu từ phiên làm việc trước.', false);
            }
        } catch (e) {
            console.error('Lỗi khôi phục trạng thái:', e);
            localStorage.removeItem('inventoryState');
        }
    }
    
    // 2. (MỚI) Tải log hóa đơn đã xuất
    const savedLogs = localStorage.getItem('exportedInvoicesLog');
    if (savedLogs) {
        try {
            exportedInvoicesLog = JSON.parse(savedLogs);
        } catch (e) {
            console.error('Lỗi khôi phục exportedInvoicesLog:', e);
            localStorage.removeItem('exportedInvoicesLog');
            exportedInvoicesLog = [];
        }
    }
    
    updateSessionStatus(); // Hàm này sẽ tự động gọi updateExportedInvoicesButtonState
}

// --- 3. TẢI DATABASE & QUẢN LÝ PHIÊN ---
function handleFileLoad() {
    const fileInput = document.getElementById('file-input');
    if (fileInput.files.length === 0) return showStatus('Vui lòng chọn Cơ sở dữ liệu!', true);

    const startLoad = () => {
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                productDatabase = [];
                productDatabaseOriginal = [];
                dailyTransactions = [];
                currentCart = [];
                exportedInvoicesLog = []; // (MỚI) Xóa log cũ khi nạp CSDL mới
                localStorage.removeItem('exportedInvoicesLog'); // (MỚI)
                
                // (*** SỬA ***) Xóa cột THUE (20) khỏi COL object
                const COL = {TIN: 16, TEN: 17, DVT: 18, GIA: 19};
                let productsLoaded = 0;
                for (let i = 3; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    // (*** SỬA ***) Cập nhật điều kiện check độ dài
                    if (row && row.length >= COL.GIA && row[COL.TEN]) {
                        const productName = String(row[COL.TEN]).trim();
                        if (productName.length > 0) {
                            productDatabase.push({
                                name: productName,
                                unit: String(row[COL.DVT] || '').trim(),
                                price: parseFloat(row[COL.GIA]) || 0,
                                // (*** SỬA ***) Xóa taxRate
                                stock: parseInt(row[COL.TIN]) || 0
                            });
                            productsLoaded++;
                        }
                    }
                }
                
                productDatabaseOriginal = JSON.parse(JSON.stringify(productDatabase));
                saveStateToStorage();
                renderCart();
                showStatus(`Bắt đầu phiên làm việc thành công! Đã nạp ${productsLoaded} sản phẩm.`);
                fileInput.value = '';
                updateFileNameDisplay();
                updateSessionStatus();

            } catch (error) { 
                showStatus(`Lỗi khi đọc tệp Excel: ${error.message}`, true); 
                updateSessionStatus();
            }
        };
        reader.onerror = () => showStatus('Không thể đọc tệp. Đã xảy ra lỗi.', true);
        reader.readAsArrayBuffer(file);
    };

    if (dailyTransactions.length > 0) {
        // (SỬA) Dùng modal xác nhận
        showConfirmModal(
            'Bắt đầu phiên mới?',
            'Bạn có chắc chắn muốn bắt đầu lại phiên làm việc? TẤT CẢ giao dịch và log hóa đơn đã lưu sẽ bị XÓA.',
            startLoad // Hàm startLoad sẽ là callback
        );
    } else {
        startLoad(); // Nếu không có giao dịch, chạy luôn
    }
}

// (*** SỬA ***)
// Bước 1: Người dùng nhấn nút "Kết thúc phiên"
function startEndSessionProcess() {
    if (productDatabase.length === 0 && dailyTransactions.length === 0) {
        return showStatus('Chưa có dữ liệu nào trong phiên. Vui lòng bắt đầu phiên trước.', true);
    }
    // Hiển thị modal chọn file
    showEndSessionModal();
}

// (*** SỬA ***)
// Bước 2: Người dùng nhấn "Tiếp tục" trên modal chọn file
function handleEndSessionContinue() {
    hideEndSessionModal();
    
    const exportSales = endSessionCheckSales.checked;
    const exportInventory = endSessionCheckInventory.checked;
    
    // Thực thi download
    if (exportSales) {
        // Kiểm tra lại (phòng hờ)
        if (dailyTransactions.length > 0) {
            exportDailySalesReport();
        } else {
            showStatus('Không có dữ liệu bán hàng để xuất.', false);
        }
    }
    if (exportInventory) {
        // Kiểm tra lại (phòng hờ)
        if (productDatabaseOriginal.length > 0 || dailyTransactions.length > 0) {
            exportInventory();
        } else {
            showStatus('Không có dữ liệu tồn kho để xuất.', false);
        }
    }
    
    // Bước 3: Hiển thị hộp thoại XÁC NHẬN CUỐI CÙNG (Fallback)
    showConfirmModal(
        'Xác nhận XÓA DỮ LIỆU?',
        'Tất cả dữ liệu phiên (CSDL, Giao dịch, Log Hóa đơn) sẽ bị XÓA SẠCH. Đây là thao tác KHÔNG THỂ HỒI PHỤC. Bạn có chắc chắn muốn kết thúc?',
        performDataDeletion // Callback là hàm xóa dữ liệu
    );
}

// (*** SỬA ***)
// Bước 4: Người dùng nhấn "Xác nhận" trên modal cuối cùng -> Xóa dữ liệu
function performDataDeletion() {
    productDatabase = [];
    productDatabaseOriginal = [];
    dailyTransactions = [];
    currentCart = [];
    exportedInvoicesLog = [];
    localStorage.removeItem('inventoryState');
    localStorage.removeItem('exportedInvoicesLog');
    
    renderCart();
    document.getElementById('customer-info-form').reset();
    document.getElementById('add-product-form').reset();
    document.getElementById('invoice-date').valueAsDate = new Date();
    selectedProduct = null;
    clearProductSelection();

    showStatus('Phiên làm việc đã kết thúc thành công! Dữ liệu đã được xóa sạch.');
    updateSessionStatus();
}


// --- 4. TÌM KIẾM & THÊM SẢN PHẨM VÀO GIỎ ---
function handleProductSearch() {
    const searchInput = document.getElementById('product-search');
    const query = searchInput.value.toLowerCase();
    const resultsContainer = document.getElementById('product-search-results');
    resultsContainer.innerHTML = '';
    
    // (SỬA) Logic kiểm tra selectedProduct
    if (selectedProduct && searchInput.value !== selectedProduct.name) {
        clearProductSelection();
    }
    
    if (devBypassMode) {
        selectedProduct = null;
        resultsContainer.innerHTML = '<div class="p-2 text-sm text-center text-gray-500 dark:text-slate-400 italic">Chế độ Bypass: Nhập tên & thông tin ở trên.</div>';
        return;
    }

    if (query.length < 2) {
        return;
    }
    
    const filteredProducts = productDatabase.filter(p => p.name.toLowerCase().includes(query)).slice(0, 50);
    filteredProducts.forEach(product => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'search-item';
        // (*** SỬA ***) Xóa tính toán giá sau thuế
        itemDiv.innerHTML = `${product.name} <small>(Tồn: ${product.stock} ${product.unit} - Giá: ${currencyFormatter.format(product.price)})</small>`;
        itemDiv.onclick = () => selectProduct(product);
        resultsContainer.appendChild(itemDiv);
    });
}

function selectProduct(product) {
    document.getElementById('product-search').value = product.name;
    selectedProduct = product; 
    document.getElementById('product-search-results').innerHTML = ''; 
    document.getElementById('product-quantity').focus();
    // (MỚI) Thêm class trực quan
    document.getElementById('product-search').classList.add('input-selected');
}

// (MỚI) Hàm xóa trạng thái "đã chọn"
function clearProductSelection() {
    selectedProduct = null;
    document.getElementById('product-search').classList.remove('input-selected');
}

function handleAddProduct(e) {
    e.preventDefault(); 
    
    // (*** SỬA ***) Logic cho Bypass Mode
    if (devBypassMode && !selectedProduct) {
        const name = document.getElementById('product-search').value.trim();
        const quantity = parseFloat(document.getElementById('product-quantity').value);
        
        if (!name || !quantity || quantity <= 0) {
            return showStatus('Bypass Mode: Vui lòng nhập Tên SP và Số Lượng hợp lệ!', true);
        }
        
        // (*** SỬA ***) Lấy thông tin từ input bypass (bỏ thuế)
        const unit = document.getElementById('product-unit').value.trim() || 'Cái';
        const price = parseFloat(document.getElementById('product-price').value) || 0;
        // (*** SỬA ***) Xóa taxRate

        const dummyProduct = { 
            name: name, unit: unit, price: price, quantity: quantity 
        };

        const existingCartItem = currentCart.find(item => item.name === name);
        if (existingCartItem) {
            // Cập nhật thông tin nếu thêm lại (giá có thể đổi)
            existingCartItem.quantity += quantity;
            existingCartItem.unit = unit;
            existingCartItem.price = price;
            // (*** SỬA ***) Xóa taxRate
        } else {
            currentCart.push(dummyProduct);
        }
        
        renderCart();
        // Reset các trường
        document.getElementById('product-search').value = '';
        document.getElementById('product-quantity').value = '';
        document.getElementById('product-unit').value = '';
        document.getElementById('product-price').value = '';
        // (*** SỬA ***) Xóa reset tax
        
        clearProductSelection();
        document.getElementById('product-search').focus();
        showStatus(`Bypass Mode: Đã thêm/cập nhật "${name}" vào giỏ hàng.`, false);
        return;
    }

    if (!selectedProduct) {
        return showStatus('Vui lòng chọn một sản phẩm từ danh sách!', true);
    }
    const name = selectedProduct.name;
    const quantity = parseFloat(document.getElementById('product-quantity').value);
    if (!quantity || quantity <= 0) return showStatus('Vui lòng nhập số lượng hợp lệ!', true);
    
    const product = selectedProduct; 
    
    if (!product) return showStatus('Lỗi: Không tìm thấy sản phẩm.', true); 
    
    const doAdd = () => {
        const existingCartItem = currentCart.find(item => item.name === name);
        if (existingCartItem) {
            existingCartItem.quantity += quantity;
        } else {
            // (*** SỬA ***) Xóa taxRate khỏi object
            currentCart.push({ 
                name: product.name, unit: product.unit, price: product.price, 
                quantity: quantity 
            });
        }
        
        renderCart();
        document.getElementById('add-product-form').reset();
        clearProductSelection(); // (MỚI)
        document.getElementById('product-search').focus();
    };
    
    if (quantity > product.stock) {
        // (SỬA) Dùng modal xác nhận
        showConfirmModal(
            'Cảnh báo Tồn Kho',
            `Sản phẩm "${name}" chỉ còn ${product.stock}. Bạn có chắc chắn muốn bán lố không?`,
            doAdd, // Hàm doAdd là callback
            'btn-warning' // (MỚI) Dùng nút màu vàng
        );
    } else {
        doAdd(); // Thêm bình thường
    }
}

function renderCart() {
    const cartBody = document.getElementById('cart-body');
    cartBody.innerHTML = '';
    // (*** SỬA ***) Chỉ cần 1 total
    let totalAmount = 0;
    
    if (currentCart.length === 0) {
        // (*** SỬA ***) Cập nhật colspan
        cartBody.innerHTML = '<tr><td colspan="7" class="text-center italic text-slate-500 dark:text-slate-400 py-6" data-label="">Giỏ hàng đang trống</td></tr>';
    }
    
    currentCart.forEach((item, index) => {
        // (*** SỬA ***) Tính toán đơn giản
        const thanhTien = item.price * item.quantity;
        totalAmount += thanhTien;
        
        const row = cartBody.insertRow();
        
        // (*** SỬA ***) Cập nhật HTML (bỏ 3 cột thuế)
        row.innerHTML = `<td data-label="STT">${index + 1}</td>
                         <td data-label="Tên hàng hóa" class="font-medium">${item.name}</td>
                         <td data-label="ĐVT">${item.unit}</td>
                         <td data-label="Số lượng" class="font-medium">${item.quantity}</td>
                         <td data-label="Đơn giá">${currencyFormatter.format(item.price)}</td>
                         <td data-label="Thành tiền" class="font-bold">${currencyFormatter.format(thanhTien)}</td>
                         <td class="cell-action">
                            <button class="btn-secondary !bg-red-50 !text-red-600 dark:!bg-red-900/50 dark:!text-red-400 hover:!bg-red-100 w-full md:w-auto !py-2 !px-3 !text-sm" onclick="removeCartItem(${index})">
                                Xóa
                            </button>
                         </td>`;
    });
    
    // (*** SỬA ***) Xóa total pre-tax
    // document.getElementById('cart-total-pretax').textContent = `Tổng cộng (Chưa thuế): ${currencyFormatter.format(totalPreTax)}`;
    document.getElementById('cart-total-posttax').textContent = `Tổng cộng: ${currencyFormatter.format(totalAmount)}`;
}

function removeCartItem(index) { 
    currentCart.splice(index, 1); 
    renderCart(); 
}

function clearCart(confirmNeeded = true) {
    if (currentCart.length === 0) return; 

    const doClear = () => {
        currentCart = [];
        document.getElementById('customer-info-form').reset();
        document.getElementById('invoice-date').valueAsDate = new Date();
        document.getElementById('save-invoice-only-check').checked = false; // (*** MỚI ***)
        
        // (*** SỬA ***) Reset form bypass (bỏ thuế)
        document.getElementById('product-unit').value = '';
        document.getElementById('product-price').value = '';
        
        renderCart();
        if (confirmNeeded) {
            showStatus('Đã xóa giỏ hàng, sẵn sàng cho đơn mới.', false);
        }
    };

    if (confirmNeeded) {
        // (SỬA) Dùng modal xác nhận
        showConfirmModal(
            'Xóa giỏ hàng?',
            'Bạn có chắc muốn xóa giỏ hàng và thông tin khách hàng hiện tại?',
            doClear
        );
    } else {
        doClear();
    }
}

// --- 5. XUẤT FILE EXCEL (HÓA ĐƠN & BÁO CÁO) ---
function exportInvoiceFile() {
    if (currentCart.length === 0) return showStatus('Giỏ hàng đang trống!', true);
    const customerInfo = getCustomerInfo();
    if (!customerInfo.name || !customerInfo.date) return showStatus('Vui lòng nhập Tên Khách Hàng và Ngày Hóa Đơn!', true);
    
    // (*** MỚI ***) Xác định loại hóa đơn (Trong CSDL, Ngoài CSDL, Hỗn hợp)
    let hasDbProduct = false;
    let hasBypassProduct = false;
    const dbProductNames = new Set(productDatabaseOriginal.map(p => p.name));
    
    for (const item of currentCart) {
        if (dbProductNames.has(item.name)) {
            hasDbProduct = true;
        } else {
            hasBypassProduct = true;
        }
    }
    
    let invoiceType = '';
    if (hasDbProduct && hasBypassProduct) {
        invoiceType = 'Hỗn hợp';
    } else if (hasBypassProduct) {
        invoiceType = 'Ngoài CSDL';
    } else {
        invoiceType = 'Trong CSDL';
    }
    // --- Kết thúc logic xác định loại
    
    
    const transaction = {
        customerInfo: customerInfo,
        items: JSON.parse(JSON.stringify(currentCart)) // Deep copy
    };
    dailyTransactions.push(transaction);

    const dataForExport = buildFlatInvoiceData([transaction]); // Dùng hàm phẳng
    
    const worksheet = XLSX.utils.aoa_to_sheet(dataForExport);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'HoaDon');
    const fileName = `HoaDon_${customerInfo.name.replace(/ /g, '_')}_${new Date().toISOString().slice(0,10)}.xlsx`;
    
    // (*** SỬA ***) Lưu vào log để tải lại, TRƯỚC KHI gọi writeFile
    try {
        const exportLogEntry = {
            id: Date.now(),
            customerName: customerInfo.name,
            fileName: fileName,
            timestamp: new Date().toISOString(),
            dataForExport: dataForExport, // Store the data
            worksheetName: 'HoaDon',
            invoiceType: invoiceType // (*** MỚI ***) Thêm loại hóa đơn
        };
        exportedInvoicesLog.push(exportLogEntry);
        localStorage.setItem('exportedInvoicesLog', JSON.stringify(exportedInvoicesLog));
    } catch (e) {
        console.error("Lỗi khi lưu log hóa đơn:", e);
        // Không chặn việc xuất file, chỉ log lỗi
        console.warn("Đã xuất hóa đơn, nhưng có lỗi khi lưu vào log phiên.");
    }

    // (*** SỬA ***) Kiểm tra checkbox "Chỉ lưu"
    const saveOnly = document.getElementById('save-invoice-only-check').checked;
    if (!saveOnly) {
        XLSX.writeFile(workbook, fileName);
    }

    // (*** SỬA ***) Chỉ cập nhật tồn kho cho các sản phẩm "Trong CSDL"
    let inventoryUpdated = false;
    currentCart.forEach(item => {
        if (dbProductNames.has(item.name)) { // Chỉ update nếu là hàng CSDL
            updateInventory(item.name, item.quantity);
            inventoryUpdated = true;
        }
    });
    
    // (*** SỬA ***) Cập nhật thông báo
    let successMessage = '';
    const actionWord = saveOnly ? 'lưu' : 'xuất';
    if (inventoryUpdated) {
        successMessage = `Đã ${actionWord} hóa đơn "${fileName}" và cập nhật tồn kho (hàng CSDL). Giao dịch đã được lưu lại.`;
    } else {
        successMessage = `Đã ${actionWord} hóa đơn (ngoài CSDL) "${fileName}". Tồn kho KHÔNG thay đổi. Giao dịch đã được lưu lại.`;
    }
    showStatus(successMessage, false);


    clearCart(false); // Sẽ tự động reset checkbox
    updateSessionStatus(); // Sẽ tự động gọi updateExportedInvoicesButtonState
}

function exportDailySalesReport() {
    if (dailyTransactions.length === 0) {
        // (*** SỬA ***)
        showStatus('Không có giao dịch nào được ghi nhận để xuất báo cáo.', false);
        return;
    }

    const dataForExport = buildFlatInvoiceData(dailyTransactions); // Dùng hàm phẳng
    
    const worksheet = XLSX.utils.aoa_to_sheet(dataForExport);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'TongHopBanHang');
    const fileName = `BaoCao_BanHang_TongHop_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(workbook, fileName);
    showStatus(`Đã xuất báo cáo bán hàng tổng hợp: "${fileName}"`);
}


// (*** SỬA ***) Cập nhật báo cáo tồn kho
function exportInventory() {
    if (productDatabaseOriginal.length === 0 && dailyTransactions.length === 0) {
        // (*** SỬA ***)
        return showStatus('Chưa có dữ liệu tồn kho hoặc giao dịch nào.', false);
    }
    
    // (*** MỚI ***) Thêm cột "Ghi chú"
    const inventoryData = [['Tên hàng hoá/dịch vụ', 'ĐVT', 'Tồn đầu ngày', 'Đã bán', 'Tồn cuối ngày', 'Ghi chú']];
    
    // 1. Xử lý hàng trong CSDL
    const dbProductNames = new Set();
    productDatabaseOriginal.forEach(originalProduct => {
        dbProductNames.add(originalProduct.name); // Thêm vào Set
        const currentProduct = productDatabase.find(p => p.name === originalProduct.name);
        const originalStock = originalProduct.stock;
        const currentStock = currentProduct ? currentProduct.stock : originalStock;
        inventoryData.push([
            originalProduct.name, originalProduct.unit, originalStock,
            originalStock - currentStock, currentStock,
            '' // Ghi chú trống
        ]);
    });
    
    // 2. (*** MỚI ***) Xử lý hàng "Ngoài CSDL" (Bypass)
    const bypassSales = new Map();
    dailyTransactions.forEach(transaction => {
        transaction.items.forEach(item => {
            if (!dbProductNames.has(item.name)) { // Nếu không có trong CSDL
                let entry = bypassSales.get(item.name) || { unit: item.unit, totalSold: 0 };
                entry.totalSold += item.quantity;
                bypassSales.set(item.name, entry);
            }
        });
    });
    
    // Thêm hàng bypass vào báo cáo
    bypassSales.forEach((data, name) => {
        inventoryData.push([
            name, 
            data.unit, 
            0, // Tồn đầu
            data.totalSold, // Đã bán
            -data.totalSold, // Tồn cuối (âm)
            'Xuất ngoài CSDL' // Ghi chú
        ]);
    });

    const worksheet = XLSX.utils.aoa_to_sheet(inventoryData);
    // (*** SỬA ***) Thêm độ rộng cột Ghi chú
    worksheet['!cols'] = [{ wch: 60 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }];
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'TonKho');
    const fileName = `BaoCao_TonKho_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(workbook, fileName);
    showStatus(`Đã xuất báo cáo tồn kho: "${fileName}"`);
}

// --- TÁI CẤU TRÚC: CÁC HÀM HELPER ---
function getCustomerInfo() {
    return {
        name: document.getElementById('customer-name').value,
        buyerName: document.getElementById('customer-buyer-name').value || document.getElementById('customer-name').value,
        address: document.getElementById('customer-address').value,
        tin: document.getElementById('customer-tin').value,
        email: document.getElementById('customer-email').value,
        paymentMethod: document.getElementById('customer-payment-method').value,
        mdvcqhns: document.getElementById('customer-mdvcqhns').value,
        cccd: document.getElementById('customer-cccd').value,
        passport: document.getElementById('customer-passport').value,
        date: document.getElementById('invoice-date').value // This returns 'yyyy-mm-dd'
    };
}

function updateInventory(productName, soldQuantity) {
    const product = productDatabase.find(p => p.name === productName);
    if (product) product.stock -= soldQuantity;
}

/**
 * Xây dựng dữ liệu Hóa đơn phẳng (theo yêu cầu A-M)
 * (SỬA ĐỔI) - Logic gộp STT cho nhiều sản phẩm
 * (*** SỬA - 2025-10-29 ***) - Áp dụng Math.round() cho giá trị tiền tệ
 * (*** SỬA - 2025-10-31 ***) - Đơn giản hóa biến (không còn pre-tax)
 */
function buildFlatInvoiceData(transactions) {
    const data = [[
        'Số thứ tự', 'Ngày hóa đơn', 'Tên khách hàng', 'Địa chỉ', 'Mã số thuế', 'Người mua hàng', 'Email', 
        'Hình thức thanh toán', 'Tên hàng hóa/dịch vụ', 'Đơn vị tính', 'Số lượng', 'Đơn giá', 'Thành tiền'
    ]];

    let sttCounter = 0; // Tăng mỗi giao dịch
    transactions.forEach(transaction => {
        sttCounter++; // STT cho giao dịch này
        const { customerInfo, items } = transaction;

        items.forEach((item, itemIndex) => { // Lấy chỉ số của sản phẩm
            const thanhTien = item.quantity * item.price; // Tính toán trên giá trị gốc
            
            // (*** SỬA ***) Áp dụng làm tròn theo yêu cầu (0 decimal places)
            const roundedPrice = Math.round(item.price);
            const roundedThanhTien = Math.round(thanhTien);
            
            let row;

            if (itemIndex === 0) {
                // Sản phẩm ĐẦU TIÊN của giao dịch
                row = [
                    sttCounter,                 // A: Số thứ tự
                    formatDateDDMMYYYY(customerInfo.date), // B: Ngày hóa đơn (SỬA)
                    customerInfo.name,          // C: Tên khách hàng
                    customerInfo.address,       // D: Địa chỉ
                    customerInfo.tin,           // E: Mã số thuế
                    customerInfo.buyerName,     // F: Người mua hàng
                    customerInfo.email,         // G: Email
                    customerInfo.paymentMethod, // H: Hình thức thanh toán
                    item.name,                  // I: Tên hàng hóa/dịch vụ
                    item.unit,                  // J: Đơn vị tính
                    item.quantity,              // K: Số lượng
                    roundedPrice,               // L: Đơn giá (ĐÃ LÀM TRÒN)
                    roundedThanhTien            // M: Thành tiền (ĐÃ LÀM TRÒN)
                ];
            } else {
                // Sản phẩm THỨ HAI TRỞ ĐI của cùng giao dịch
                row = [
                    sttCounter,                 // A: Số thứ tự (GIỮ NGUYÊN)
                    '',                         // B: (Trống)
                    '',                         // C: (Trống)
                    '',                         // D: (Trống)
                    '',                         // E: (Trống)
                    '',                         // F: (Trống)
                    '',                         // G: (Trống)
                    '',                         // H: (Trống)
                    item.name,                  // I: Tên hàng hóa/dịch vụ
                    item.unit,                  // J: Đơn vị tính
                    item.quantity,              // K: Số lượng
                    roundedPrice,               // L: Đơn giá (ĐÃ LÀM TRÒN)
                    roundedThanhTien            // M: Thành tiền (ĐÃ LÀM TRÒN)
                ];
            }
            data.push(row);
        });
    });
    return data;
}

// --- (MỚI) Đồng hồ (Tách ra) ---
function startClock() {
    const timeEl = document.getElementById('current-time-display');
    const dateEl = document.getElementById('current-date-display');
    if (!timeEl || !dateEl) return; 
    // (SỬA) Tùy chọn ngày đã bị xóa, sẽ dùng hàm formatDateDDMMYYYY
    // const dateOptions = { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit' };

    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('vi-VN', { hour12: false }); 
        // (SỬA) Sử dụng hàm format mới
        // const dateString = now.toLocaleDateString('vi-VN', dateOptions);
        const dateString = formatDateDDMMYYYY(now);
        timeEl.textContent = timeString;
        // (SỬA) Cập nhật textContent
        // dateEl.textContent = dateString.charAt(0).toUpperCase() + dateString.slice(1);
        dateEl.textContent = dateString;
    }
    updateClock(); 
    setInterval(updateClock, 1000); 
}

// --- CÁC HÀM NÂNG CAO (DEVELOPER) ---
function showAdvancedModal() {
    document.getElementById('advanced-modal').classList.remove('hidden');
}
function hideAdvancedModal() {
    document.getElementById('advanced-modal').classList.add('hidden');
}

// --- (*** SỬA ***) QUẢN LÝ MODAL HÓA ĐƠN ĐÃ XUẤT ---
function setupExportedInvoicesModal() {
    exportedInvoicesModal = document.getElementById('exported-invoices-modal');
    exportedInvoicesList = document.getElementById('exported-invoices-list');
    
    document.getElementById('view-exports-btn').addEventListener('click', showExportedInvoicesModal);
    document.getElementById('modal-close-btn-exports').addEventListener('click', hideExportedInvoicesModal);
    document.getElementById('modal-overlay-bg-exports').addEventListener('click', hideExportedInvoicesModal);
}

// (*** MỚI ***) QUẢN LÝ MODAL THÔNG TIN ---
function setupInfoModal() {
    if (!infoModal) return;
    document.getElementById('info-mode-btn').addEventListener('click', showInfoModal);
    document.getElementById('modal-close-btn-info').addEventListener('click', hideInfoModal);
    document.getElementById('modal-overlay-bg-info').addEventListener('click', hideInfoModal);
}

function showInfoModal() {
    if (infoModal) infoModal.classList.remove('hidden');
}

function hideInfoModal() {
    if (infoModal) infoModal.classList.add('hidden');
}

// (*** MỚI ***) QUẢN LÝ MODAL KẾT THÚC PHIÊN ---
function setupEndSessionModal() {
    if (!endSessionModal) return;
    endSessionModalCancelBtn.addEventListener('click', hideEndSessionModal);
    endSessionModalContinueBtn.addEventListener('click', handleEndSessionContinue);
}

function showEndSessionModal() {
    if (!endSessionModal) return;
    // (MỚI) Chỉ check "Bán hàng" nếu có giao dịch
    endSessionCheckSales.checked = dailyTransactions.length > 0;
    endSessionCheckSales.disabled = dailyTransactions.length === 0;
    
    // (MỚI) Chỉ check "Tồn kho" nếu có CSDL hoặc giao dịch (cho hàng bypass)
    endSessionCheckInventory.checked = productDatabaseOriginal.length > 0 || dailyTransactions.length > 0;
    endSessionCheckInventory.disabled = !(productDatabaseOriginal.length > 0 || dailyTransactions.length > 0);

    endSessionModal.classList.remove('hidden');
}

function hideEndSessionModal() {
    if (endSessionModal) endSessionModal.classList.add('hidden');
}

// (*** MỚI ***) QUẢN LÝ MODAL XEM CSDL ---
function setupDatabaseViewerModal() {
    if (!databaseViewerModal) return;
    document.getElementById('view-database-btn').addEventListener('click', showDatabaseViewerModal);
    document.getElementById('modal-close-btn-db').addEventListener('click', hideDatabaseViewerModal);
    document.getElementById('modal-overlay-bg-db').addEventListener('click', hideDatabaseViewerModal);
    dbModalSearchInput.addEventListener('keyup', renderDatabaseViewerList);
}

function showDatabaseViewerModal() {
    if (!databaseViewerModal) return;
    renderDatabaseViewerList(); // Render với search query rỗng
    databaseViewerModal.classList.remove('hidden');
    dbModalSearchInput.focus();
}

function hideDatabaseViewerModal() {
    if (databaseViewerModal) {
        databaseViewerModal.classList.add('hidden');
        dbModalSearchInput.value = ''; // Xóa search query khi đóng
    }
}

function renderDatabaseViewerList() {
    if (!databaseViewerList) return;
    
    const query = dbModalSearchInput.value.toLowerCase();
    const filteredDB = productDatabase.filter(p => p.name.toLowerCase().includes(query));
    
    databaseViewerList.innerHTML = ''; // Xóa nội dung cũ
    
    if (filteredDB.length === 0) {
        const message = productDatabase.length === 0 
            ? 'Cơ sở dữ liệu trống.' 
            : 'Không tìm thấy sản phẩm nào khớp.';
        // (*** SỬA ***) Cập nhật colspan
        databaseViewerList.innerHTML = `<tr><td colspan="5" class="text-center italic text-slate-500 dark:text-slate-400 py-6">${message}</td></tr>`;
        return;
    }
    
    filteredDB.forEach((product, index) => {
        const row = databaseViewerList.insertRow();
        // (*** SỬA ***) Cập nhật HTML (bỏ thuế)
        row.innerHTML = `
            <td class="!p-2 text-center">${index + 1}</td>
            <td class="!p-2 font-medium">${product.name}</td>
            <td class="!p-2">${product.unit}</td>
            <td class="!p-2 text-right">${currencyFormatter.format(product.price)}</td>
            <td class="!p-2 text-right font-medium">${product.stock}</td>
        `;
    });
}


function showExportedInvoicesModal() {
    exportedInvoicesList.innerHTML = ''; // Xóa nội dung cũ
    
    if (exportedInvoicesLog.length === 0) {
        // (*** SỬA ***) Cập nhật colspan
        exportedInvoicesList.innerHTML = '<tr><td colspan="5" class="text-center italic text-slate-500 dark:text-slate-400 py-6" data-label="">Chưa có hóa đơn nào được xuất trong phiên này.</td></tr>';
    } else {
        // Hiển thị từ mới nhất đến cũ nhất
        exportedInvoicesLog.slice().reverse().forEach(logEntry => {
            const row = exportedInvoicesList.insertRow();
            // (*** SỬA ***) Thêm cột "Loại"
            row.innerHTML = `
                <td data-label="Khách hàng" class="font-medium">${logEntry.customerName}</td>
                <td data-label="Thời gian">${new Date(logEntry.timestamp).toLocaleString('vi-VN')}</td>
                <td data-label="Tên file" class="text-sm italic">${logEntry.fileName}</td>
                <td data-label="Loại" class="font-medium">${logEntry.invoiceType || 'Trong CSDL'}</td> <td class="cell-action text-center">
                    <button class="btn-primary !py-1.5 !px-3 !text-sm w-full" onclick="reExportInvoice(${logEntry.id})">
                        Tải lại
                    </button>
                </td>
            `;
        });
    }
    exportedInvoicesModal.classList.remove('hidden');
}

function hideExportedInvoicesModal() {
    exportedInvoicesModal.classList.add('hidden');
}

function reExportInvoice(id) {
    const logEntry = exportedInvoicesLog.find(log => log.id === id);
    if (!logEntry) { 
        return showStatus('Lỗi: Không tìm thấy hóa đơn để tải lại!', true); 
    }
    
    try {
        const worksheet = XLSX.utils.aoa_to_sheet(logEntry.dataForExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, logEntry.worksheetName || 'HoaDon');
        XLSX.writeFile(workbook, logEntry.fileName);
        showStatus(`Đã tải lại: ${logEntry.fileName}`, false);
    } catch (e) {
        console.error("Lỗi khi tải lại hóa đơn:", e);
        showStatus(`Lỗi khi tải lại: ${e.message}`, true);
    }
}


// (*** SỬA ***) Cập nhật logic Bật/Tắt Bypass Mode
function toggleBypassMode() {
    devBypassMode = !devBypassMode;
    const btn = document.getElementById('dev-bypass-btn');
    const statusSpan = btn.querySelector('span');
    const bypassDiv = document.getElementById('bypass-inputs');
    
    if (devBypassMode) {
        statusSpan.textContent = '[BẬT]';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-warning');
        bypassDiv.classList.remove('hidden'); // (*** MỚI ***)
        showStatus('Chế độ Bypass CSDL đã BẬT. Giờ bạn có thể thêm sản phẩm thủ công.', false);
    } else {
        statusSpan.textContent = '[TẮT]';
        btn.classList.add('btn-warning');
        btn.classList.remove('btn-success');
        bypassDiv.classList.add('hidden'); // (*** MỚI ***)
        showStatus('Chế độ Bypass CSDL đã TẮT.', false);
    }
    updateSessionStatus();
    handleProductSearch(); 
}

function exportEmptyInvoice() {
    const dataForExport = buildFlatInvoiceData([]); 
    const worksheet = XLSX.utils.aoa_to_sheet(dataForExport);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'HoaDon_Trong');
    XLSX.writeFile(workbook, 'Template_HoaDon_Trong.xlsx');
    showStatus('Đã xuất template Hóa Đơn (trống) - định dạng phẳng A-M.', false);
    hideAdvancedModal();
}

function exportEmptySalesReport() {
    const dataForExport = buildFlatInvoiceData([]); // (SỬA) Dùng hàm phẳng
    const worksheet = XLSX.utils.aoa_to_sheet(dataForExport);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'TongHopBanHang_Trong');
    XLSX.writeFile(workbook, 'Template_BaoCao_BanHang_TongHop_Trong.xlsx');
    showStatus('Đã xuất template Báo Cáo Bán Hàng (trống) - định dạng phẳng A-M.', false); // (SỬA)
    hideAdvancedModal();
}

// (*** SỬA ***) Cập nhật template tồn kho
function exportEmptyInventory() {
    const inventoryData = [['Tên hàng hoá/dịch vụ', 'ĐVT', 'Tồn đầu ngày', 'Đã bán', 'Tồn cuối ngày', 'Ghi chú']];
    const worksheet = XLSX.utils.aoa_to_sheet(inventoryData);
    worksheet['!cols'] = [{ wch: 60 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }];
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'TonKho_Trong');
    XLSX.writeFile(workbook, 'Template_BaoCao_TonKho_Trong.xlsx');
    showStatus('Đã xuất template Báo Cáo Tồn Kho (trống).', false);
    hideAdvancedModal();
}

// --- (*** MỚI ***) CÁC HÀM BACKUP & RESTORE ---

/**
 * Xuất toàn bộ session (inventory state & logs) ra file JSON.
 */
function handleBackupSession() {
    try {
        const inventoryState = localStorage.getItem('inventoryState');
        const exportedInvoicesLog = localStorage.getItem('exportedInvoicesLog');
        
        if (!inventoryState && !exportedInvoicesLog) {
            return showStatus('Không có dữ liệu phiên để backup.', true);
        }

        const backupData = {
            inventoryState: inventoryState ? JSON.parse(inventoryState) : null,
            exportedInvoicesLog: exportedInvoicesLog ? JSON.parse(exportedInvoicesLog) : null,
            backupMetadata: {
                timestamp: new Date().toISOString(),
                version: "1.5"
            }
        };
        
        const jsonString = JSON.stringify(backupData, null, 2); // Pretty print
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.href = url;
        a.download = `VTNN_ThanhNhan_Backup_${dateStr}.json`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showStatus('Đã xuất file backup phiên thành công.', false);
        hideAdvancedModal();
    
    } catch (e) {
        console.error('Lỗi khi tạo backup:', e);
        showStatus(`Lỗi khi tạo backup: ${e.message}`, true);
    }
}

/**
 * Xử lý file .json được chọn để khôi phục session.
 */
function handleRestoreSession(event) {
    const fileInput = event.target;
    const file = fileInput.files[0];
    
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        const jsonString = e.target.result;
        
        try {
            const backupData = JSON.parse(jsonString);

            // Phải check `inventoryState` và `exportedInvoicesLog` tồn tại (có thể là null, nhưng key phải có)
            if (backupData && typeof backupData.inventoryState !== 'undefined' && typeof backupData.exportedInvoicesLog !== 'undefined') {
                
                // Dùng modal xác nhận
                showConfirmModal(
                    'Xác nhận Khôi Phục Phiên?',
                    'Hành động này sẽ XÓA SẠCH phiên làm việc hiện tại và thay thế bằng dữ liệu từ file. Bạn có chắc chắn muốn tiếp tục?',
                    () => {
                        try {
                            // Stringify lại trước khi lưu vào localStorage
                            const invState = backupData.inventoryState ? JSON.stringify(backupData.inventoryState) : null;
                            const logState = backupData.exportedInvoicesLog ? JSON.stringify(backupData.exportedInvoicesLog) : null;
                            
                            if (invState) {
                                localStorage.setItem('inventoryState', invState);
                            } else {
                                localStorage.removeItem('inventoryState');
                            }
                            
                            if (logState) {
                                localStorage.setItem('exportedInvoicesLog', logState);
                            } else {
                                localStorage.removeItem('exportedInvoicesLog');
                            }

                            showStatus('Đã khôi phục phiên thành công! Trang sẽ tự động tải lại...', false);
                            
                            // Tải lại trang để load state mới
                            setTimeout(() => {
                                location.reload();
                            }, 1500);

                        } catch (saveError) {
                            console.error('Lỗi khi lưu state khôi phục:', saveError);
                            showStatus(`Lỗi khi lưu state khôi phục: ${saveError.message}`, true);
                        }
                    },
                    'btn-danger' // Dùng nút đỏ cho hành động nguy hiểm
                );

            } else {
                throw new Error('File backup không hợp lệ hoặc thiếu dữ liệu.');
            }

        } catch (parseError) {
            console.error('Lỗi khi đọc file backup:', parseError);
            showStatus(`Lỗi khi đọc file backup: ${parseError.message}`, true);
        } finally {
            // Reset file input để có thể chọn lại file cũ (nếu fail)
            fileInput.value = '';
            hideAdvancedModal();
        }
    };
    
    reader.onerror = () => {
        showStatus('Không thể đọc file đã chọn.', true);
        fileInput.value = '';
    };
    
    reader.readAsText(file);
}

</script>

  </body>
</html>